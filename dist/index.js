var re=Object.defineProperty;var ee=Object.getOwnPropertySymbols;var ye=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable;var te=(r,e,t)=>e in r?re(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,se=(r,e)=>{for(var t in e||(e={}))ye.call(e,t)&&te(r,t,e[t]);if(ee)for(var t of ee(e))he.call(e,t)&&te(r,t,e[t]);return r};var V=(r,e)=>{for(var t in e)re(r,t,{get:e[t],enumerable:!0})};var a=(r,e,t)=>new Promise((s,n)=>{var i=c=>{try{f(t.next(c))}catch(l){n(l)}},o=c=>{try{f(t.throw(c))}catch(l){n(l)}},f=c=>c.done?s(c.value):Promise.resolve(c.value).then(i,o);f((t=t.apply(r,e)).next())});var Z={};V(Z,{Audio:()=>C,CSV:()=>I,Image:()=>D,PDF:()=>R,PDF_experimental:()=>j,Text:()=>A,Video:()=>U});var Y={};V(Y,{FilterFile:()=>p,TmpFile:()=>g,isArrayOfBuffer:()=>Ve,isArrayOfString:()=>Le,isUrl:()=>z,loader:()=>G,parser:()=>$});import{Mutex as S}from"async-mutex";import P,{Node as Ce}from"@ryn-bsd/is-file";import{Readable as ae}from"stream";import{isAnyArrayBuffer as ge,isUint8Array as we}from"util/types";import E from"fs";import ne from"path";import{any2buffer as Te,array2buffer as Be,buffer2readable as xe,isReadable as ie,isReadableStream as be,isStream as Pe,readable2buffer as Fe,readablestream2buffer as ve,stream2buffer as Oe,string2buffer as Se,uint8array2buffer as De,url2buffer as Ae}from"@ryn-bsd/from-buffer-to";import oe from"is-base64";import Ie from"fast-glob";import Re from"puppeteer";var u=class r{constructor(){}static stream(e,t){return e.pipe(t)}static initBrowser(e){return Re.launch(e)}static loadFile(e){return a(this,null,function*(){return Array.isArray(e)?Promise.all(e.map(t=>r.loadFile(t))):E.promises.readFile(e)})}static loadDir(e){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(s=>r.loadDir(s)));let t=yield E.promises.readdir(e);return r.loadFile(t.map(s=>ne.join(e,s)))})}static loadGlob(e,t){return a(this,null,function*(){var o;let s=yield Ie(e,t),n=(o=t==null?void 0:t.cwd)!=null?o:process.cwd();return(yield Promise.all(s.map(f=>a(this,null,function*(){let c=ne.join(n,f),l=yield E.promises.stat(c);return l.isFile()?r.loadFile(c):l.isDirectory()?r.loadDir(c):null})))).filter(f=>f!==null)})}static loadUrl(e){return a(this,null,function*(){return Array.isArray(e)?Promise.all(e.map(t=>r.loadUrl(t))):Ae(e)})}static toBuffer(e){return a(this,null,function*(){return Array.isArray(e)?Promise.all(e.map(t=>r.toBuffer(t))):Buffer.isBuffer(e)?e:z(e)?r.loadUrl(e):we(e)?De(e):ge(e)?Be(e):Pe(e)?Oe(e):be(e)?ve(e):ie(e)&&ae.isReadable(e)?Fe(e):typeof e=="string"?(yield E.promises.stat(e)).isFile()?r.loadFile(e):oe(e,{allowEmpty:!1})?Buffer.from(e,"base64"):Se(e,!1):Te(e)})}static toReadable(e){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(s=>r.toReadable(s)));if(ie(e)&&ae.isReadable(e))return e;let t=yield r.toBuffer(e);return xe(t)})}static toBase64(e,t="base64"){return a(this,null,function*(){return Array.isArray(e)?Promise.all(e.map(n=>r.toBase64(n))):typeof e=="string"&&oe(e)?e:(yield r.toBuffer(e)).toString(t)})}static toFile(e){return a(this,null,function*(){yield Promise.all(e.map(t=>a(this,null,function*(){let s=yield r.toBuffer(t.input);return E.promises.writeFile(t.path,s)})))})}};var p=class r{constructor(...e){this.input=e}application(){return a(this,null,function*(){let{applications:e}=yield r.filter(...this.input);return e})}audio(){return a(this,null,function*(){let{audios:e}=yield r.filter(...this.input);return e})}font(){return a(this,null,function*(){let{fonts:e}=yield r.filter(...this.input);return e})}image(){return a(this,null,function*(){let{images:e}=yield r.filter(...this.input);return e})}model(){return a(this,null,function*(){let{models:e}=yield r.filter(...this.input);return e})}text(){return a(this,null,function*(){let{texts:e}=yield r.filter(...this.input);return e})}video(){return a(this,null,function*(){let{videos:e}=yield r.filter(...this.input);return e})}custom(e){return a(this,null,function*(){let t=yield u.toBuffer(this.input);return(yield P.isCustom(t,e)).filter(n=>n.valid).map(n=>n.value)})}static filter(...e){return a(this,null,function*(){let t=yield u.toBuffer(e),s={applications:new S,audios:new S,fonts:new S,images:new S,models:new S,texts:new S,videos:new S},n={applications:[],audios:[],fonts:[],images:[],models:[],texts:[],videos:[]};return yield Promise.all(t.map(i=>a(this,null,function*(){if(yield P.isApplication(i)){let o=yield s.applications.acquire();n.applications.push(i),o()}else if(yield P.isAudio(i)){let o=yield s.audios.acquire();n.audios.push(i),o()}else if(yield P.isFont(i)){let o=yield s.fonts.acquire();n.fonts.push(i),o()}else if(yield P.isImage(i)){let o=yield s.images.acquire();n.images.push(i),o()}else if(yield P.isModel(i)){let o=yield s.models.acquire();n.models.push(i),o()}else if(yield P.isText(i)){let o=yield s.texts.acquire();n.texts.push(i),o()}else if(yield P.isVideo(i)){let o=yield s.videos.acquire();n.videos.push(i),o()}}))),n})}static type(e){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(s=>r.type(s)));let t=yield u.toBuffer(e);return Ce.type(t)})}static mime(e){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(s=>r.mime(s)));let t=yield r.type(e);return t==null?void 0:t.mime})}static extension(e){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(s=>r.extension(s)));let t=yield r.type(e);return t==null?void 0:t.ext})}};import{writeFile as Ue}from"fs/promises";import{randomUUID as ke}from"crypto";import Me from"path";import{dir as Ee}from"tmp-promise";var g=class r{constructor(...e){this.paths=[];this.files=e}createFn(e){return a(this,null,function*(){var i;let t=(i=yield p.extension(e))!=null?i:"";if(t.length===0)throw new Error(`${r.name}: Unknown file when create`);let s=r.generateFileName(t),n=Me.join(this.tmp.path,s);yield Ue(n,e),this.paths.push(n)})}create(){return a(this,null,function*(){yield Promise.all(this.files.map(this.createFn.bind(this)))})}init(e){return a(this,null,function*(){return this.tmp=yield Ee(se({unsafeCleanup:!0},e)),yield this.create(),this})}clean(){return a(this,null,function*(){yield this.tmp.cleanup(),this.paths.splice(0,this.paths.length)})}static generateFileName(e){return`${ke()}_${Date.now()}.${e}`}};var G={};V(G,{loadDir:()=>K,loadFile:()=>M,loadGlob:()=>je,loadUrl:()=>L});import J from"fs";import fe from"path";import ze from"fast-glob";import{url2buffer as Ne}from"@ryn-bsd/from-buffer-to";function M(r){return a(this,null,function*(){return Array.isArray(r)?Promise.all(r.map(e=>M(e))):J.promises.readFile(r)})}function K(r){return a(this,null,function*(){if(Array.isArray(r))return Promise.all(r.map(t=>K(t)));let e=yield J.promises.readdir(r);return M(e.map(t=>fe.join(r,t)))})}function je(r,e){return a(this,null,function*(){var i;let t=(i=e==null?void 0:e.cwd)!=null?i:process.cwd(),s=yield ze(r,e);return(yield Promise.all(s.map(o=>a(this,null,function*(){let f=fe.join(t,o),c=yield J.promises.stat(f);return c.isFile()?M(f):c.isDirectory()?K(f):null})))).filter(o=>o!==null)})}function L(r){return a(this,null,function*(){return Array.isArray(r)?Promise.all(r.map(e=>L(e))):Ne(r)})}var $={};V($,{toBase64:()=>de,toBuffer:()=>N,toFile:()=>et,toReadable:()=>pe});import{isAnyArrayBuffer as Ge,isUint8Array as $e}from"util/types";import{Readable as ce}from"stream";import ue from"fs";function Ve(r){if(!Array.isArray(r))return!1;for(let e of r)if(!Buffer.isBuffer(e))return!1;return!0}function Le(r){if(!Array.isArray(r))return!1;for(let e of r)if(typeof e!="string")return!1;return!0}function z(r){if(typeof r!="string")return!1;try{return new URL(r),!0}catch(e){return!1}}import{any2buffer as He,array2buffer as We,buffer2readable as qe,isReadable as le,isReadableStream as Je,isStream as Ke,readable2buffer as Ye,readablestream2buffer as Qe,stream2buffer as Xe,string2buffer as Ze,uint8array2buffer as _e}from"@ryn-bsd/from-buffer-to";import me from"is-base64";function N(r){return a(this,null,function*(){return Array.isArray(r)?Promise.all(r.map(e=>N(e))):Buffer.isBuffer(r)?r:z(r)?L(r):$e(r)?_e(r):Ge(r)?We(r):Ke(r)?Xe(r):Je(r)?Qe(r):le(r)&&ce.isReadable(r)?Ye(r):typeof r=="string"?(yield ue.promises.stat(r)).isFile()?M(r):me(r,{allowEmpty:!1})?Buffer.from(r,"base64"):Ze(r,!1):He(r)})}function pe(r){return a(this,null,function*(){if(Array.isArray(r))return Promise.all(r.map(t=>pe(t)));if(le(r)&&ce.isReadable(r))return r;let e=yield N(r);return qe(e)})}function de(r,e="base64"){return a(this,null,function*(){return Array.isArray(r)?Promise.all(r.map(s=>de(s))):typeof r=="string"&&me(r)?r:(yield N(r)).toString(e)})}function et(r){return a(this,null,function*(){yield Promise.all(r.map(e=>a(this,null,function*(){let t=yield N(e.input);return ue.promises.writeFile(e.path,t)})))})}import tt from"fs";import rt from"path";import st from"fast-glob";import{createWorker as at}from"tesseract.js";import nt from"sharp";var D=class r extends u{constructor(...e){super(),this.images=e}get length(){return this.images.length}getImages(){return[...this.images]}setImages(e){return a(this,null,function*(){let s=(yield Promise.all(this.images.map((i,o)=>a(this,null,function*(){return e(i,o)})))).filter(i=>Buffer.isBuffer(i)&&i.length>0),n=yield r.filter(...s);return this.images=n,this.length})}append(...e){return a(this,null,function*(){let t=yield r.filter(...e);return this.images.push(...t),this.length})}extend(...e){return e.forEach(t=>{this.images.push(...t.getImages())}),this.length}clone(){return new r(...this.images)}clean(){this.images=[]}filter(){return a(this,null,function*(){return this.images=yield r.filter(...this.images),this.length})}metadata(){return a(this,null,function*(){return this.custom(e=>e.metadata())})}watermark(s){return a(this,arguments,function*(e,t={}){let{resize:n,gravity:i="center",alpha:o=.5,tile:f=!1,blend:c="over",premultiplied:l}=t,y=yield u.toBuffer(e),T=yield r.newSharp(y).resize(n).ensureAlpha(o).composite([{input:Buffer.from([0,0,0,Math.round(255*o)]),raw:{width:1,height:1,channels:4},tile:!0,blend:"dest-in"}]).toBuffer();return this.custom(h=>h.composite([{input:T,gravity:i,blend:c,tile:f,premultiplied:l}]).toBuffer({resolveWithObject:!0}))})}convert(e,t){return a(this,null,function*(){return this.custom(s=>s.toFormat(e,t).toBuffer({resolveWithObject:!0}))})}ocr(e){return a(this,null,function*(){let t=yield at(e),s=yield Promise.all(this.images.map(n=>t.recognize(n)));if(yield t.terminate(),process.env.NODE_ENV==="development"||process.env.NODE_ENV==="test"){let n=process.cwd(),i=yield st("*.traineddata",{cwd:n});yield Promise.all(i.map(o=>tt.promises.unlink(rt.join(n,o))))}return s.map(n=>n.data)})}custom(e){return a(this,null,function*(){return Promise.all(this.images.map((t,s)=>a(this,null,function*(){return e(r.newSharp(t),s)})))})}static filter(...e){return a(this,null,function*(){return new p(...e).image()})}static justBuffer(e){return Array.isArray(e)?e.map(t=>r.justBuffer(t)):e.data}static screenshot(e,t){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(f=>a(this,null,function*(){return r.screenshot(f,t)})));let s=yield u.initBrowser(),n=yield s.newPage(),i=yield n.goto(e,{waitUntil:"networkidle2"});if(i===null||!i.ok())throw new Error(`${r.name}: Can't fetch (${e})`);let o=yield n.screenshot(t);return yield s.close(),o})}static fromFile(...e){return a(this,null,function*(){let t=yield u.loadFile(e);return r.new(t)})}static fromUrl(...e){return a(this,null,function*(){let t=yield u.loadUrl(e);return r.new(t)})}static newSharp(e,t){return nt(e,t).clone()}static new(e){return a(this,null,function*(){let t=yield r.filter(...e);if(t.length===0)throw new Error(`${r.name}: Non valid image`);return new r(...t)})}static isImage(e){return e instanceof r}};import m from"zlib";import d from"crypto";var A=class r extends u{constructor(...e){super(),this.texts=e}get length(){return this.texts.length}get supportedHashes(){return d.getHashes()}get supportedCiphers(){return d.getCiphers()}getTexts(){return[...this.texts]}setTexts(e){return a(this,null,function*(){let s=(yield Promise.all(this.texts.map((n,i)=>a(this,null,function*(){return e(n,i)})))).filter(n=>Buffer.isBuffer(n)&&n.length>0);return this.texts=s,this.length})}append(...e){return a(this,null,function*(){let t=e.filter(s=>Buffer.isBuffer(s)&&s.length>0);return this.texts.push(...t),this.length})}extend(...e){return e.forEach(t=>{this.texts.push(...t.getTexts())}),this.length}clone(){return new r(...this.texts)}clean(){this.texts=[]}filter(){return a(this,null,function*(){return this.texts=yield r.filter(...this.texts),this.length})}charactersMap(e){let t=new Map,s=e.toString();for(let n of s){let i=n.charCodeAt(0);t.has(i)?t.set(i,t.get(i)+1):t.set(i,1)}return t}metadata(){return a(this,null,function*(){return this.custom(e=>({size:e.length,charactersMap:this.charactersMap(e)}))})}compressAsync(e,t){return a(this,null,function*(){return Promise.all(r.compress(this.texts,e,r.gzipAsync,r.deflateAsync,r.deflateRawAsync,r.brotliCompressAsync,t))})}decompressAsync(e,t){return a(this,null,function*(){return Promise.all(r.decompress(this.texts,e,r.gunzipAsync,r.inflateAsync,r.inflateRawAsync,r.brotliDecompressAsync,r.unzipAsync,t))})}compressStream(e,t){return a(this,null,function*(){let s=yield u.toReadable(this.texts);return r.compress(s,e,r.gzipStream,r.deflateStream,r.deflateRawStream,r.brotliCompressStream,t)})}decompressStream(e,t){return a(this,null,function*(){let s=yield u.toReadable(this.texts);return r.decompress(s,e,r.gunzipStream,r.inflateStream,r.inflateRawStream,r.brotliDecompressStream,r.unzipStream,t)})}compressSync(e,t){return r.compress(this.texts,e,r.gzipSync,r.deflateSync,r.deflateRawSync,r.brotliCompressSync,t)}decompressSync(e,t){return r.decompress(this.texts,e,r.gunzipSync,r.inflateSync,r.inflateRawSync,r.brotliDecompressSync,r.unzipSync,t)}isHashSupported(e){return this.supportedHashes.includes(e)}hash(e,t){return a(this,null,function*(){return this.custom(s=>d.createHash(e,t).update(s).digest())})}hmac(e,t,s){return a(this,null,function*(){return this.custom(n=>{switch(Buffer.isBuffer(t)){case!0:return d.createHmac(e,t,s).update(n).digest();default:{let i=d.randomBytes(32);return{key:i,hash:d.createHmac(e,i,s).update(n).digest()}}}})})}isCipherSupported(e){return this.supportedCiphers.includes(e)}cipher(e,t,s,n){return a(this,null,function*(){return this.custom(i=>{let o,f;if(typeof t=="undefined"&&typeof s=="undefined"){o=d.randomBytes(32),f=d.randomBytes(16);let c=d.createCipheriv(e,o,f,n);return{key:o,iv:o,encrypt:Buffer.concat([c.update(i),c.final()])}}else if(typeof t=="string"&&typeof s=="undefined"){f=d.randomBytes(16);let c=d.createCipheriv(e,t,null,n);return{iv:f,encrypt:Buffer.concat([c.update(i),c.final()])}}else if(typeof t=="undefined"&&typeof s=="string"){o=d.randomBytes(32);let c=d.createCipheriv(e,o,s,n);return{key:o,encrypt:Buffer.concat([c.update(i),c.final()])}}else if(typeof t=="string"&&typeof s=="string"){let c=d.createCipheriv(e,t,s,n);return Buffer.concat([c.update(i),c.final()])}else if(typeof t=="string"&&typeof s=="boolean"&&!s){let c=d.createCipheriv(e,t,null,n);return Buffer.concat([c.update(i),c.final()])}})})}isDecipherSupported(e){return this.isCipherSupported(e)}decipher(i,o){return a(this,arguments,function*(e,t,s=null,n={}){return this.custom(f=>{let c=d.createDecipheriv(e,t,s,n);return Buffer.concat([c.update(f),c.final()])})})}custom(e){return a(this,null,function*(){return Promise.all(this.texts.map((t,s)=>a(this,null,function*(){return e(t,s)})))})}static compress(e,t,s,n,i,o,f){return e.map(c=>{switch(t){case"gzip":return s(c,f);case"deflate":return n(c,f);case"deflate-raw":return i(c,f);case"brotli-compress":return o(c,f);default:throw new TypeError(`${r.name}: Invalid compression method (${t})`)}})}static decompress(e,t,s,n,i,o,f,c){return e.map(l=>{switch(t){case"gunzip":return s(l,c);case"inflate":return n(l,c);case"inflate-raw":return i(l,c);case"brotli-decompress":return o(l,c);case"unzip":return f(l,c);default:throw new TypeError(`${r.name}: Invalid decompression method (${t})`)}})}static filter(...e){return a(this,null,function*(){return new p(...e).text()})}static fromFile(...e){return a(this,null,function*(){let t=yield u.loadFile(e);return r.new(t)})}static fromUrl(...e){return a(this,null,function*(){let t=yield u.loadUrl(e);return r.new(t)})}static new(e){let t=e.filter(s=>s.length>0);if(t.length===0)throw new Error(`${r.name}: Non valid text`);return new r(...t)}static isText(e){return e instanceof r}static gzipAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.gzip(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static deflateAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.deflate(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static deflateRawAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.deflateRaw(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static brotliCompressAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.brotliCompress(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static gunzipAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.gunzip(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static inflateAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.inflate(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static inflateRawAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.inflateRaw(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static brotliDecompressAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.brotliDecompress(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static unzipAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{m.unzip(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static gzipStream(e,t={}){let s=m.createGzip(t);return u.stream(e,s)}static deflateStream(e,t={}){let s=m.createDeflate(t);return u.stream(e,s)}static deflateRawStream(e,t={}){let s=m.createDeflateRaw(t);return u.stream(e,s)}static brotliCompressStream(e,t={}){let s=m.createBrotliCompress(t);return u.stream(e,s)}static gunzipStream(e,t={}){let s=m.createGunzip(t);return u.stream(e,s)}static inflateStream(e,t={}){let s=m.createInflate(t);return u.stream(e,s)}static inflateRawStream(e,t={}){let s=m.createInflateRaw(t);return u.stream(e,s)}static brotliDecompressStream(e,t={}){let s=m.createBrotliDecompress(t);return u.stream(e,s)}static unzipStream(e,t={}){let s=m.createUnzip(t);return u.stream(e,s)}static gzipSync(e,t={}){return m.gzipSync(e,t)}static deflateSync(e,t={}){return m.deflateSync(e,t)}static deflateRawSync(e,t={}){return m.deflateRawSync(e,t)}static brotliCompressSync(e,t={}){return m.brotliCompressSync(e,t)}static gunzipSync(e,t={}){return m.gunzipSync(e,t)}static inflateSync(e,t={}){return m.inflateSync(e,t)}static inflateRawSync(e,t={}){return m.inflateRawSync(e,t)}static brotliDecompressSync(e,t={}){return m.brotliDecompressSync(e,t)}static unzipSync(e,t={}){return m.unzipSync(e,t)}};import*as B from"csv";import*as F from"csv/sync";var I=class r extends u{constructor(...e){super(),this.csvs=e}get length(){return this.csvs.length}getCsvs(){return[...this.csvs]}setCsvs(e){return a(this,null,function*(){let s=(yield Promise.all(this.csvs.map((n,i)=>a(this,null,function*(){return e(n,i)})))).filter(n=>Buffer.isBuffer(n)&&n.length>0);return this.csvs=s,this.length})}append(...e){return a(this,null,function*(){let t=e.filter(s=>Buffer.isBuffer(s)&&s.length>0);return this.csvs.push(...t),this.length})}extend(...e){return e.forEach(t=>{this.csvs.push(...t.getCsvs())}),this.length}clone(){return new r(...this.csvs)}clean(){this.csvs=[]}filter(){return a(this,null,function*(){return this.csvs=yield r.filter(...this.csvs),this.length})}metadata(e){return a(this,null,function*(){return this.custom(t=>a(this,null,function*(){var n,i;let s=yield r.parseAsync(t,e);return{size:t.length,rows:s.length,columns:(i=(n=s==null?void 0:s[0])==null?void 0:n.length)!=null?i:0}}))})}parseAsync(e){return a(this,null,function*(){return this.custom(t=>r.parseAsync(t,e))})}transformAsync(e,t,s){return a(this,null,function*(){return Promise.all(e.map(n=>r.transformAsync(n,t,s)))})}stringifyAsync(e,t){return a(this,null,function*(){return Promise.all(e.map(s=>r.stringifyAsync(s,t)))})}parseStream(e){return a(this,null,function*(){return(yield u.toReadable(this.csvs)).map(s=>r.parseStream(s,e))})}transformStream(e,t,s){return a(this,null,function*(){return(yield u.toReadable(e)).map(i=>r.transformStream(i,t,s))})}stringifyStream(e,t){return a(this,null,function*(){return(yield u.toReadable(e)).map(n=>r.stringifyStream(n,t))})}parseSync(e){return this.csvs.map(t=>r.parseSync(t,e))}transformSync(e,t,s){return e.map(n=>r.transformSync(n,t,s))}stringifySync(e,t){return e.map(s=>r.stringifySync(s,t))}custom(e){return a(this,null,function*(){return Promise.all(this.csvs.map((t,s)=>a(this,null,function*(){return e(t,s)})))})}static filter(...e){return a(this,null,function*(){return new p(...e).custom("csv")})}static fromFile(...e){return a(this,null,function*(){let t=yield u.loadFile(e);return r.new(t)})}static fromUrl(...e){return a(this,null,function*(){let t=yield u.loadUrl(e);return r.new(t)})}static new(e){let t=e.filter(s=>s.length>0);if(t.length===0)throw new Error(`${r.name}: Non valid csv`);return new r(...t)}static isCSV(e){return e instanceof r}static generateAsync(){return a(this,arguments,function*(e={}){return new Promise((t,s)=>{B.generate(e,(n,i)=>{if(n)return s(n);t(i)})})})}static parseAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{B.parse(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static transformAsync(n,i){return a(this,arguments,function*(e,t,s={}){return new Promise((o,f)=>{B.transform(e,s,t,(c,l)=>{if(c)return f(c);o(l)})})})}static stringifyAsync(s){return a(this,arguments,function*(e,t={}){return new Promise((n,i)=>{B.stringify(e,t,(o,f)=>{if(o)return i(o);n(f)})})})}static generateStream(e={}){return B.generate(e)}static parseStream(e,t={}){return u.stream(e,B.parse(t))}static transformStream(e,t,s={}){return u.stream(e,B.transform(s,t))}static stringifyStream(e,t={}){return u.stream(e,B.stringify(t))}static generateSync(e={}){return F.generate(e)}static parseSync(e,t={}){return F.parse(e,t)}static transformSync(e,t,s={}){return F.transform(e,s,t)}static stringifySync(e,t={}){return F.stringify(e,t)}};import{PageSizes as it,PDFDocument as H}from"pdf-lib";var R=class r extends u{constructor(...e){super(),this.pdfs=e}get length(){return this.pdfs.length}getPdfs(){return[...this.pdfs]}setPdfs(e){return a(this,null,function*(){let s=(yield Promise.all(this.pdfs.map((i,o)=>a(this,null,function*(){return e(i,o)})))).filter(i=>Buffer.isBuffer(i)&&i.length>0),n=yield r.filter(...s);return this.pdfs=n,this.length})}append(...e){return a(this,null,function*(){let t=yield r.filter(...e);return this.pdfs.push(...t),this.length})}extend(...e){return e.forEach(t=>{this.pdfs.push(...t.getPdfs())}),this.length}clone(){return new r(...this.pdfs)}clean(){this.pdfs=[]}filter(){return a(this,null,function*(){return this.pdfs=yield r.filter(...this.pdfs),this.length})}getDocuments(e){return a(this,null,function*(){return Promise.all(this.pdfs.map(t=>r.load(t.buffer,e)))})}metadata(e){return a(this,null,function*(){return this.custom(t=>({title:t.getTitle(),author:t.getAuthor(),subject:t.getSubject(),creator:t.getCreator(),keywords:t.getKeywords(),producer:t.getProducer(),pageCount:t.getPageCount(),pageIndices:t.getPageIndices(),creationDate:t.getCreationDate(),modificationDate:t.getModificationDate()}),e)})}getPages(e){return a(this,null,function*(){return this.custom(t=>t.getPages(),e)})}getForm(e){return a(this,null,function*(){return this.custom(t=>t.getForm(),e)})}merge(e){return a(this,null,function*(){let t=yield r.create(e==null?void 0:e.create);return(yield this.custom(n=>t.copyPages(n,n.getPageIndices()),e==null?void 0:e.load)).forEach(n=>n.forEach(i=>t.addPage(i))),r.save(t)})}custom(e,t){return a(this,null,function*(){let s=yield this.getDocuments(t);return Promise.all(s.map((n,i)=>a(this,null,function*(){return e(n,i)})))})}static fromFile(...e){return a(this,null,function*(){let t=yield u.loadFile(e);return r.new(t)})}static fromUrl(...e){return a(this,null,function*(){let t=yield u.loadUrl(e);return r.new(t)})}static fromImage(s){return a(this,arguments,function*(e,t={}){var v,O;if(Array.isArray(e))return Promise.all(e.map(k=>r.fromImage(k,t)));let[n,i]=yield Promise.all([new p(e).custom("png"),new p(e).custom("jpg")]);if(i.length===0&&n.length===0)throw new Error(`${r.name}: Invalid images to convert to pdf`);let{pageSize:o=it.A4,scaleImage:f,position:c}=t,l=yield H.create(t.create),y=l.addPage(o),T=y.getSize(),h;n.length>0?h=yield l.embedPng(e.buffer):h=yield l.embedJpg(e.buffer);let b=h.size();return typeof f=="number"?b=h.scale(f):Array.isArray(f)?b=h.scaleToFit(f[0],f[1]):b=h.scaleToFit(T.width,T.height),y.drawImage(h,{x:(v=c==null?void 0:c[0])!=null?v:0,y:(O=c==null?void 0:c[1])!=null?O:0,width:b.width,height:b.height}),l})}static generate(e,t){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(f=>r.generate(f,t)));let s=yield u.initBrowser(),n=yield s.newPage(),i=yield n.goto(e,{waitUntil:"networkidle2"});if(i===null||!i.ok())throw new Error(`${r.name}: Can't fetch (${e})`);let o=yield n.pdf(t);return yield s.close(),o})}static filter(...e){return a(this,null,function*(){return new p(...e).custom("pdf")})}static save(e,t){return a(this,null,function*(){if(Array.isArray(e))return Promise.all(e.map(n=>r.save(n,t)));let s=yield e.save(t);return u.toBuffer(s)})}static load(e,t){return a(this,null,function*(){return H.load(e,t)})}static create(e){return a(this,null,function*(){return H.create(e)})}static document(){return H}static new(e){return a(this,null,function*(){let t=yield r.filter(...e);if(t.length===0)throw new Error(`${r.name}: Non valid pdf`);return new r(...t)})}static isPDF(e){return e instanceof r}};import*as w from"mupdf";var j=class r{constructor(...e){this.pdfs=[];this.pdfs=e}metadata(){return a(this,null,function*(){return this.custom(e=>({format:e.getMetaData(w.Document.META_FORMAT),encryption:e.getMetaData(w.Document.META_ENCRYPTION),author:e.getMetaData(w.Document.META_INFO_AUTHOR),title:e.getMetaData(w.Document.META_INFO_TITLE),subject:e.getMetaData(w.Document.META_INFO_SUBJECT),keywords:e.getMetaData(w.Document.META_INFO_KEYWORDS),creator:e.getMetaData(w.Document.META_INFO_CREATOR),producer:e.getMetaData(w.Document.META_INFO_PRODUCER),countUnsavedVersions:e.countUnsavedVersions(),countVersions:e.countVersions(),countObjects:e.countObjects(),countPages:e.countPages(),wasRepaired:e.wasRepaired(),language:e.getLanguage(),version:e.getVersion(),creationDate:e.getMetaData(w.Document.META_INFO_CREATIONDATE),modificationDate:e.getMetaData(w.Document.META_INFO_MODIFICATIONDATE)}))})}getTexts(){return a(this,null,function*(){return this.custom(e=>{let t=[],s=e.countPages();for(let n=0;n<s;n++){let i=e.loadPage(n);t.push(i.toStructuredText("preserve-whitespace").asJSON())}return t})})}getImages(){return a(this,null,function*(){return this.custom(e=>{let t=[],s=e.countPages();for(let n=0;n<s;n++){let f,i=e.loadPage(n),o=[];i.toStructuredText("preserve-images").walk({onImageBlock(c,l,y){return a(this,null,function*(){let h=y.toPixmap().asPNG(),b=yield u.toBuffer(h);o.push(b)})}}),t.push(o)}return t})})}annotations(){return a(this,null,function*(){return this.custom(e=>{let t=[],s=e.countPages();for(let n=0;n<s;n++){let i=e.loadPage(n);t.push(i.getAnnotations())}return t})})}links(){return a(this,null,function*(){return this.custom(e=>{let t=[],s=e.countPages();for(let n=0;n<s;n++){let o=e.loadPage(n).getLinks().map(f=>({bounds:f.getBounds(),link:f.getURI(),isExternal:f.isExternal()}));t.push(o)}return t})})}bake(e,t){return a(this,null,function*(){return this.custom(s=>{s.bake(e,t)})})}search(e){return a(this,null,function*(){return this.custom(t=>{})})}custom(e){return a(this,null,function*(){return Promise.all(this.pdfs.map((t,s)=>a(this,null,function*(){let n=r.open(t);return e(n,s)})))})}static open(e){return new w.PDFDocument(e)}static needsPassword(e){return r.open(e).needsPassword()}};import ot from"fluent-ffmpeg";import{path as ft}from"@ffmpeg-installer/ffmpeg";import{path as ct}from"@ffprobe-installer/ffprobe";import Q from"path";var x=class r extends u{constructor(...e){super(),this.avs=e}get length(){return this.avs.length}clean(){this.avs=[]}metadata(){return a(this,null,function*(){return this.custom(e=>new Promise((t,s)=>{e.ffprobe((n,i)=>{if(n)return s(n);t(i)})}))})}convert(e){return a(this,null,function*(){return this.custom((t,s)=>new Promise((n,i)=>{let o=Q.join(s.tmp.path,g.generateFileName(e));t.toFormat(e).on("end",()=>{u.loadFile(o).then(n,i)}).on("error",i).output(o).run()}))})}spilt(e,t=0){return a(this,null,function*(){return this.custom((s,n,i)=>a(this,null,function*(){var h,b;let f=(h=(yield new Promise((v,O)=>{s.ffprobe((k,q)=>{if(k)return O(k);v(q)})})).format.duration)!=null?h:0;if(f===0)throw new Error(`${r.name}: Empty av duration`);if(t>=f)throw new Error(`${r.name}: start time is bigger then the av duration`);let c=(b=yield p.extension(this.avs[i]))!=null?b:"";if(c.length===0)throw new Error(`${r.name}: Unknown av format`);let l=n.paths[i],y=[],T=t;for(;T<f;){let v=Math.min(e,f-T),O=Q.join(n.tmp.path,g.generateFileName(c)),k=yield new Promise((q,_)=>{r.newFfmpeg(l).setStartTime(T).setDuration(v).on("end",()=>{u.loadFile(O).then(q,_)}).on("error",_).output(O).run()});y.push(k),T+=v}return y}))})}merge(e,t=30){return a(this,null,function*(){let s=yield this.convert(e),n=yield new g(...s).init(),i=Q.join(n.tmp.path,g.generateFileName(e)),o=yield new Promise((f,c)=>{let l=r.newFfmpeg(n.paths[0]);n.paths.forEach((y,T)=>{T!==0&&l.input(y)}),l.fps(t).on("start",y=>{}).on("end",()=>{u.loadFile(i).then(f,c)}).on("error",c).mergeToFile(i,n.tmp.path)});return yield n.clean(),o})}custom(e){return a(this,null,function*(){let t=yield new g(...this.avs).init(),s=yield Promise.all(t.paths.map((n,i)=>a(this,null,function*(){return e(r.newFfmpeg(n),t,i)})));return yield t.clean(),s})}static newFfmpeg(e,t){return ot(t).clone().setFfmpegPath(ft).setFfprobePath(ct).input(e)}};var C=class r extends x{constructor(...e){super(...e)}getAudios(){return[...this.avs]}setAudios(e){return a(this,null,function*(){let s=(yield Promise.all(this.avs.map((i,o)=>a(this,null,function*(){return e(i,o)})))).filter(i=>Buffer.isBuffer(i)&&i.length>0),n=yield r.filter(...s);return this.avs=n,this.length})}append(...e){return a(this,null,function*(){let t=yield r.filter(...e);return this.avs.push(...t),this.length})}extend(...e){return e.forEach(t=>{this.avs.push(...t.getAudios())}),this.length}clone(){return new r(...this.avs)}filter(){return a(this,null,function*(){return this.avs=yield r.filter(...this.avs),this.length})}static filter(...e){return new p(...e).audio()}static fromFile(...e){return a(this,null,function*(){let t=yield u.loadFile(e);return r.new(t)})}static fromUrl(...e){return a(this,null,function*(){let t=yield u.loadUrl(e);return r.new(t)})}static new(e){return a(this,null,function*(){let t=yield r.filter(...e);if(t.length===0)throw new Error(`${r.name}: Non valid audio`);return new r(...t)})}static isAudio(e){return e instanceof r}};import X from"path";var U=class r extends x{constructor(...e){super(...e)}getVideos(){return[...this.avs]}setVideos(e){return a(this,null,function*(){let s=(yield Promise.all(this.avs.map((i,o)=>a(this,null,function*(){return e(i,o)})))).filter(i=>Buffer.isBuffer(i)&&i.length>0),n=yield r.filter(...s);return this.avs=n,this.length})}append(...e){return a(this,null,function*(){let t=yield r.filter(...e);return this.avs.push(...t),this.length})}extend(...e){return e.forEach(t=>{this.avs.push(...t.getVideos())}),this.length}clone(){return new r(...this.avs)}filter(){return a(this,null,function*(){return this.avs=yield r.filter(...this.avs),this.length})}only(){return a(this,null,function*(){return this.custom((e,t,s)=>a(this,null,function*(){var o;let n=(o=yield p.extension(this.avs[s]))!=null?o:"";if(n.length===0)throw new Error(`${r.name}: Unknown video format`);let i=X.join(t.tmp.path,g.generateFileName(n));return new Promise((f,c)=>{e.noAudio().on("end",()=>{x.loadFile(i).then(f,c)}).on("error",c).output(i).run()})}))})}audio(e){return a(this,null,function*(){let t=yield this.metadata();return this.custom((s,n,i)=>a(this,null,function*(){if(typeof t[i].streams.find(l=>l.codec_type==="audio")=="undefined")return null;let c=X.join(n.tmp.path,g.generateFileName(e));return new Promise((l,y)=>{s.noVideo().toFormat(e).on("end",()=>{x.loadFile(c).then(l,y)}).on("error",y).output(c).run()})}))})}screenshot(e){return a(this,null,function*(){return this.custom((t,s)=>a(this,null,function*(){let n=[];return new Promise((i,o)=>{t.screenshot({filename:"frame.png",timemarks:e},s.tmp.path).on("filenames",f=>{n=f.map(c=>X.join(s.tmp.path,c))}).on("end",()=>{x.loadFile(n).then(i,o)}).on("error",o)})}))})}static filter(...e){return a(this,null,function*(){return new p(...e).video()})}static fromFile(...e){return a(this,null,function*(){let t=yield x.loadFile(e);return r.new(t)})}static fromUrl(...e){return a(this,null,function*(){let t=yield x.loadUrl(e);return r.new(t)})}static generateTimemarks(e,t=1){return a(this,null,function*(){var i;if(Array.isArray(e))return Promise.all(e.map(o=>r.generateTimemarks(o,t)));let s=[],n=(i=e.format.duration)!=null?i:0;for(let o=0;o<n;o+=t)s.push(o);return s})}static new(e){return a(this,null,function*(){let t=yield r.filter(...e);if(t.length===0)throw new Error(`${r.name}: Non valid video`);return new r(...t)})}static isVideo(e){return e instanceof r}};var W=class{constructor(...e){this.files=e}image(){return D.new(this.files)}pdf(){return R.new(this.files)}csv(){return I.new(this.files)}text(){return A.new(this.files)}video(){return U.new(this.files)}audio(){return C.new(this.files)}};export{W as Processor,Z as core,Y as helper};
